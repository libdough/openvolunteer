{% extends "base.html" %}

{% block title %}
  {{ org.name }}
{% endblock title %}
{% block content %}
  <a href="{% url 'orgs:org_list' %}"
     class="text-muted mb-4 d-inline-flex align-items-center gap-1">← Back to organizations</a>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-0">{{ org.name }}</h1>
      <div class="text-muted small">{{ org.slug }}</div>
    </div>
    {% if can_edit_org %}
      <a href="{% url 'orgs:org_edit' slug=org.slug %}"
         class="btn btn-outline-primary btn-sm">Edit organization</a>
    {% endif %}
  </div>
  <div class="row g-4">
    <!-- LEFT COLUMN -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header">Overview</div>
        <div class="card-body">
          <dl class="row mb-0 small">
            <dt class="col-5">Members</dt>
            <dd class="col-7">
              {{ org.member_count }}
            </dd>
            <dt class="col-5">People</dt>
            <dd class="col-7">
              {{ org.people_count }}
            </dd>
            <dt class="col-5">Created</dt>
            <dd class="col-7">
              {{ org.created_at|date:"M j, Y" }}
            </dd>
          </dl>
        </div>
      </div>
      <div class="card shadow-sm mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Calendar</span>
          <a href="{% url 'orgs:org_calendar' slug=org.slug %}"
             class="btn btn-sm btn-outline-secondary">Expand</a>
        </div>
        <div class="card-body p-2">
          <div class="mini-calendar"
               data-events-url="{% url 'events:calendar' %}"
               data-can-edit="{{ can_manage_events|yesno:'true,false' }}"
               data-create-url="{% url 'events:event_create' %}"
               data-org-id="{{ org.id }}"></div>
          {% include "components/calendar.html" %}
        </div>
      </div>
    </div>
    <!-- RIGHT COLUMN -->
    <div class="col-lg-8">
      <!-- TICKETS -->
      {% with tickets=tickets title="Open Tickets" ticket_count=ticket_count show_claim=True ticket_querystring=ticket_querystring empty_message="No open tickets for this organization." %}
        {% include "components/ticket_list_card.html" %}
      {% endwith %}
      <!-- EVENTS -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Events</span>
          {% if can_manage_events %}
            <a href="{% url 'events:event_create' %}?org={{ org.id }}"
               class="btn btn-sm btn-outline-primary">Add Event</a>
          {% endif %}
        </div>
        <div class="card-body p-0">
          {% if events %}
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Title</th>
                  <th>When</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for event in events %}
                  <tr class="{% if event.event_status == 'finished' %}text-muted{% endif %}">
                    <td class="fw-medium">
                      <a href="{% url 'events:event_detail' event.id %}">{{ event.title }}</a>
                    </td>
                    <td class="small">
                      {% with start=event.starts_at end=event.ends_at %}
                        {% include "components/datetime_range.html" %}
                      {% endwith %}
                    </td>
                    <td>
                      <span class="badge {% if event.event_status == 'draft' %}bg-secondary {% elif event.event_status == 'published' %}bg-success {% elif event.event_status == 'finished' %}bg-light text-dark {% else %}bg-secondary{% endif %}">
                        {{ event.get_event_status_display }}
                      </span>
                    </td>
                    <td class="text-end">
                      <a href="{% url 'events:event_detail' event.id %}"
                         class="btn btn-sm btn-outline-secondary">View</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="p-4 text-muted text-center">No events for this organization yet.</div>
          {% endif %}
        </div>
      </div>
      <!-- MEMBERS -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>
            Members
            <span class="badge bg-secondary ms-2">{{ org.member_count }}</span>
          </span>
          {% if can_manage_members %}
            <a href="{% url 'orgs:org_members' slug=org.slug %}"
               class="btn btn-sm btn-outline-primary">Manage</a>
          {% endif %}
        </div>
        <ul class="list-group list-group-flush">
          {% for m in memberships %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span class="fw-medium">{{ m.user.username }}</span>
              <span class="badge bg-secondary">{{ m.get_role_display }}</span>
            </li>
          {% empty %}
            <li class="list-group-item text-muted">No members yet</li>
          {% endfor %}
          {% if org.member_count > memberships|length %}
            <li class="list-group-item text-muted small text-center">
              Showing first {{ memberships|length }} of {{ org.member_count }} members
            </li>
          {% endif %}
        </ul>
      </div>
      <!-- PEOPLE -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>
            People
            <span class="badge bg-secondary ms-2">{{ org.people_count }}</span>
          </span>
          {% if can_manage_people %}
            <a href="{% url 'orgs:org_people' slug=org.slug %}"
               class="btn btn-sm btn-outline-primary">Manage</a>
          {% endif %}
        </div>
        <div class="card-body p-0">
          {% if people %}
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Discord</th>
                  <th>Tags</th>
                </tr>
              </thead>
              <tbody>
                {% for link in people %}
                  <tr>
                    <td class="fw-medium">
                      <a href="{% url 'people:person_detail' person_id=link.person.id %}">{{ link.person.full_name }}</a>
                    </td>
                    <td class="text-muted">{{ link.person.discord|default:"—" }}</td>
                    <td>
                      {% for tagging in link.person.taggings.all %}
                        <span class="tag-pill" style="--tag-color: {{ tagging.tag.color_hex }};">{{ tagging.tag.name }}</span>
                      {% empty %}
                        <span class="text-muted">—</span>
                      {% endfor %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            {% if org.people_count > people|length %}
              <div class="p-2 text-muted small text-center">Showing first {{ people|length }} of {{ org.people_count }} people</div>
            {% endif %}
          {% else %}
            <div class="p-4 text-muted">No people associated with this organization.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
