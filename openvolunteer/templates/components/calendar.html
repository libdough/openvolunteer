<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css"
      rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
  (function() {
    /* ===============================
       Helpers
       =============================== */

    const EVENT_STATUS_STYLES = {
      draft: {
        backgroundColor: "#e5e7eb",
        borderColor: "#9ca3af",
        textColor: "#374151",
        icon: "ðŸ“",
        label: "Draft",
      },
      scheduled: {
        backgroundColor: "#2563eb",
        borderColor: "#1e40af",
        textColor: "#ffffff",
      },
      finished: {
        backgroundColor: "#6b7280",
        borderColor: "#4b5563",
        textColor: "#ffffff",
      },
      cancelled: {
        backgroundColor: "#dc2626",
        borderColor: "#991b1b",
        textColor: "#ffffff",
      },
    };

    const SHIFT_STYLE = {
      backgroundColor: "#4caf50",
      borderColor: "#2d6930",
      textColor: "#ffffff",
    }


    function updateEventTimes(info) {
      info.el.classList.add("opacity-50");

      const [type, uuid] = info.event.id.includes(":") ?
        info.event.id.split(":") : ["events", info.event.id];

      fetch(`/${type}/${uuid}/update-times/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
          start: info.event.start.toISOString(),
          end: info.event.end?.toISOString() || info.event.start.toISOString(),
        }),
      }).then(response => {
        if (!response.ok) {
          info.revert();
          alert("Unable to update event");
        }
        info.el.classList.remove("opacity-50");
      });
    }

    function buildCalendar(el) {
      const isMini = el.classList.contains("mini-calendar");
      const canEdit = el.dataset.canEdit === "true";
      const createUrl = el.dataset.createUrl;
      const orgId = el.dataset.orgId;

      return new FullCalendar.Calendar(el, {
        initialView: "dayGridMonth",
        height: "auto",

        headerToolbar: isMini ? {
          left: "prev",
          center: "title",
          right: "next"
        } : {
          left: "prev,next today",
          center: "title",
          right: "multiMonthYear,dayGridMonth,timeGridWeek,timeGridDay",
        },

        navLinks: true,
        nowIndicator: true,

        editable: canEdit,
        selectable: canEdit,
        selectMirror: true,
        unselectAuto: true,
        eventStartEditable: canEdit,
        eventDurationEditable: canEdit,
        eventResizableFromStart: canEdit,

        select(info) {
          if (!canEdit) return;

          const params = new URLSearchParams({
            org: el.dataset.orgId,
            starts_at: info.start.toISOString(),
            ends_at: (info.end || info.start).toISOString(),
          });

          window.location.href =
            `${el.dataset.createUrl}?${params.toString()}`;
        },

        slotDuration: "00:15:00",
        snapDuration: "00:15:00",
        slotLabelInterval: "01:00",

        events: el.dataset.eventsUrl,

        eventDrop: updateEventTimes,
        eventResize: updateEventTimes,

        eventDidMount(info) {
          const type = info.event.extendedProps.type;
          const status = info.event.extendedProps.status;
          const style = type === "event" ? EVENT_STATUS_STYLES[status] : SHIFT_STYLE;

          if (!style) return;

          // Apply colors
          info.el.style.backgroundColor = style.backgroundColor;
          info.el.style.borderColor = style.borderColor;
          info.el.style.color = style.textColor;

          // Draft indicator
          if (status === "draft") {
            const titleEl = info.el.querySelector(".fc-event-title");
            if (titleEl && !titleEl.dataset.draftApplied) {
              titleEl.innerHTML = `${style.icon} ${style.label}: ${titleEl.innerHTML}`;
              titleEl.dataset.draftApplied = "true";
            }
          }
        }
      });
    }

    /* ===============================
       Auto-init on DOM ready
       =============================== */

    document.addEventListener("DOMContentLoaded", function() {
      document
        .querySelectorAll(".calendar, .mini-calendar")
        .forEach(el => {
          const calendar = buildCalendar(el);
          calendar.render();
        });
    });
  })();
</script>
