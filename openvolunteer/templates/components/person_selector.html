<!-- djlint:off -->
{% with input_name=input_name|default:"people" %}
<div class="person-selector border rounded p-3">

  <!-- Bulk add -->
  <div class="mb-3 d-flex gap-2">
    <button type="button" class="btn btn-sm btn-outline-secondary bulk-toggle">
      ➕ Bulk add
    </button>

    {% if allow_add_all %}
      <button
        type="button"
        class="btn btn-sm btn-outline-secondary js-person-selector-add-all"
        data-org-id="{{ event.org.id|default:'' }}"
        data-event-id="{{ event.id|default:'' }}"
        data-shift-id="{{ shift.id|default:'' }}"
      >
        Add all matching people
      </button>
    {% endif %}
  </div>

  <!-- Bulk panel -->
  <div class="bulk-panel d-none mb-4 p-3 bg-light border rounded">

    {% if bulk_tags %}
      <div class="mb-3">
        <label class="form-label small">Tags</label>
        <input type="text" class="form-control form-control-sm mb-2 bulk-tags-filter" placeholder="Filter tags…">
        <select class="form-select bulk-tags" multiple size="6">
          {% for tag in bulk_tags %}
            <option value="{{ tag.id }}">{{ tag.name }}</option>
          {% endfor %}
        </select>
      </div>
    {% endif %}

    {% if bulk_events %}
      <div class="mb-3">
        <label class="form-label small">Previous participation</label>
        <select class="form-select bulk-event">
          <option value="">— Select an event —</option>
          {% for event in bulk_events %}
            <option value="{{ event.id }}">{{ event.name }}</option>
          {% endfor %}
        </select>
      </div>
    {% endif %}

    <button type="button" class="btn btn-sm btn-primary bulk-add">
      Add matching people
    </button>
  </div>

  <!-- Search -->
  <div class="mb-3">
    <label class="form-label small fw-semibold">Search people</label>
    <input type="text" class="form-control person-search-input" autocomplete="off">
  </div>

  <div class="list-group mb-3 person-search-results"></div>

  <!-- Selected -->
  <div class="person-selected">
    <div class="fw-semibold mb-2">
      Selected people (<span class="person-selected-count">0</span>)
    </div>
    <div class="person-selected-list"></div>
    <div class="text-muted small fst-italic empty-selected d-none">
      No people selected yet.
    </div>
  </div>

  <!-- Hidden select -->
  <select name="{{ input_name }}" multiple hidden></select>

  <script>
    (function () {

      function qs(sel, root) {
        return (root || document).querySelector(sel);
      }

      function qsa(sel, root) {
        return Array.from((root || document).querySelectorAll(sel));
      }

      function personLabel(p) {
        return p.name || p.full_name || p.email || p.id;
      }

      function addPeople(selector, people) {
        const select = qs('select[name="{{ input_name }}"]', selector);
        const list = qs(".person-selected-list", selector);
        const count = qs(".person-selected-count", selector);
        const empty = qs(".empty-selected", selector);

        const existing = new Set(
          Array.from(select.options).map(o => o.value)
        );

        people.forEach(p => {
          if (existing.has(p.id)) return;

          // hidden select option (for POST)
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.selected = true;
          opt.textContent = personLabel(p);
          select.appendChild(opt);

          // visible UI
          const row = document.createElement("div");
          row.className = "d-flex justify-content-between align-items-center border rounded px-2 py-1 mb-1";
          row.dataset.personId = p.id;
          row.innerHTML = `
            <div>
              <strong>${personLabel(p)}</strong>
              ${p.discord ? `<div class="text-muted small">${p.discord}</div>` : ""}
            </div>
            <button type="button" class="btn btn-sm btn-link text-danger remove-person">✕</button>
          `;
          list.appendChild(row);
        });

        const total = select.options.length;
        count.textContent = total;
        empty.classList.toggle("d-none", total > 0);
      }

      async function fetchPeople(params) {
        const res = await fetch(`/people/search/?${params.toString()}`, {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        if (!res.ok) throw new Error("Search failed");
        const data = await res.json();
        return data.results || [];
      }

      document.addEventListener("click", async (e) => {

        const selector = e.target.closest(".person-selector");
        if (!selector) return;

        /* Toggle bulk panel */
        if (e.target.closest(".bulk-toggle")) {
          e.preventDefault();
          qs(".bulk-panel", selector).classList.toggle("d-none");
          return;
        }

        /* Remove person */
        if (e.target.closest(".remove-person")) {
          const row = e.target.closest("[data-person-id]");
          const id = row.dataset.personId;

          qs(`select[name="{{ input_name }}"] option[value="${id}"]`, selector)?.remove();
          row.remove();

          const count = qs(".person-selected-count", selector);
          count.textContent = qs(`select[name="{{ input_name }}"]`, selector).options.length;
          qs(".empty-selected", selector)
            .classList.toggle("d-none", count.textContent !== "0");
          return;
        }

        /* Add all */
        const addAll = e.target.closest(".js-person-selector-add-all");
        if (addAll) {
          e.preventDefault();

          const params = new URLSearchParams();
          if (addAll.dataset.orgId) params.append("org_id", addAll.dataset.orgId);
          if (addAll.dataset.eventId) params.append("event_id", addAll.dataset.eventId);
          if (addAll.dataset.shiftId) params.append("shift_id", addAll.dataset.shiftId);

          const people = await fetchPeople(params);
          if (!people.length) return alert("No matching people found.");
          if (people.length > 100 && !confirm(`Add ${people.length} people?`)) return;

          addPeople(selector, people);
          return;
        }

        /* Bulk add */
        const bulkAdd = e.target.closest(".bulk-add");
        if (bulkAdd) {
          e.preventDefault();

          const params = new URLSearchParams();
          const addAllBtn = qs(".js-person-selector-add-all", selector);

          if (addAllBtn?.dataset.orgId) params.append("org_id", addAllBtn.dataset.orgId);
          if (addAllBtn?.dataset.eventId) params.append("event_id", addAllBtn.dataset.eventId);
          if (addAllBtn?.dataset.shiftId) params.append("shift_id", addAllBtn.dataset.shiftId);

          const tags = qs(".bulk-tags", selector);
          if (tags) {
            const ids = Array.from(tags.selectedOptions).map(o => o.value);
            if (ids.length) params.append("tag_ids", ids.join(","));
          }

          const ev = qs(".bulk-event", selector);
          if (ev?.value) params.append("participated_event_id", ev.value);

          const people = await fetchPeople(params);
          if (!people.length) return alert("No matching people found.");
          if (people.length > 100 && !confirm(`Add ${people.length} people?`)) return;

          addPeople(selector, people);
        }
      });

      /* Search typing */
      document.addEventListener("input", async (e) => {
        const input = e.target.closest(".person-search-input");
        if (!input) return;

        const selector = input.closest(".person-selector");
        const q = input.value.trim();
        if (q.length < 2) return;

        const params = new URLSearchParams({ q });
        const addAllBtn = qs(".js-person-selector-add-all", selector);

        if (addAllBtn?.dataset.orgId) params.append("org_id", addAllBtn.dataset.orgId);
        if (addAllBtn?.dataset.eventId) params.append("event_id", addAllBtn.dataset.eventId);
        if (addAllBtn?.dataset.shiftId) params.append("shift_id", addAllBtn.dataset.shiftId);

        const results = qs(".person-search-results", selector);
        results.innerHTML = "";

        const people = await fetchPeople(params);
        people.forEach(p => {
          const row = document.createElement("button");
          row.type = "button";
          row.className = "list-group-item list-group-item-action";
          row.textContent = personLabel(p);
          row.onclick = () => addPeople(selector, [p]);
          results.appendChild(row);
        });
      });
      document.addEventListener("input", (e) => {
        const input = e.target.closest(".bulk-tags-filter");
        if (!input) return;

        const selector = input.closest(".person-selector");
        const select = qs(".bulk-tags", selector);
        if (!select) return;

        const q = input.value.toLowerCase();

        Array.from(select.options).forEach(opt => {
          opt.hidden = !opt.textContent.toLowerCase().includes(q);
        });
      });

    })();
  </script>
</div>
{% endwith %}
