{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ ticket.name }}</h1>
    <div>
      {% if ticket.claimable and not ticket.assigned_to %}
        <a href="{% url 'tickets:claim_ticket' ticket.id %}"
           class="btn btn-sm btn-outline-primary">Claim ticket</a>
      {% endif %}
      {% if ticket.assigned_to == request.user %}
        <a href="{% url 'tickets:unclaim_ticket' ticket.id %}"
           class="btn btn-sm btn-outline-secondary">Unclaim</a>
      {% endif %}
    </div>
  </div>
  <div class="row">
    <!-- Main content -->
    <div class="col-md-8">
      <div class="card mb-3">
        <div class="card-body">
          {% load markdown_extras %}

          <div class="markdown-body">{{ ticket.description|render_markdown|safe }}</div>
        </div>
      </div>
      <!-- Activity -->
      <div class="card mt-4">
        <div class="card-header">
          <strong>Activity</strong>
        </div>
        <div class="card-body p-0">
          {% if ticket.audit_logs.exists %}
            <ul class="list-group list-group-flush">
              {% for log in ticket.audit_logs.all %}
                <li class="list-group-item small">
                  <div class="d-flex justify-content-between">
                    <span class="{% if not log.success %}text-danger{% endif %}">{{ log.message }}</span>
                    <span class="text-muted">{{ log.created_at|date:"M d, H:i" }}</span>
                  </div>
                  <div class="text-muted">
                    {% if log.actor %}
                      {{ log.actor }}
                    {% else %}
                      System
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="p-3 text-muted text-center">No activity yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Sidebar -->
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-5">Status</dt>
            <dd class="col-7">
              {{ ticket.get_status_display }}
            </dd>
            <dt class="col-5">Priority</dt>
            <dd class="col-7">
              P{{ ticket.priority }}
            </dd>
            <dt class="col-5">Assigned</dt>
            <dd class="col-7">
              {% if ticket.assigned_to %}
                {{ ticket.assigned_to.name|default:ticket.assigned_to }}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </dd>
            <dt class="col-5">Reporter</dt>
            <dd class="col-7">
              {{ ticket.reporter.name|default:ticket.reporter }}
            </dd>
            <dt class="col-5">Event</dt>
            <dd class="col-7">
              {% if ticket.event %}
                <a href="{% url 'events:event_detail' ticket.event.id %}">{{ ticket.event.title }}</a>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
            <dt class="col-5">Batch</dt>
            <dd class="col-7">
              {% if ticket.batch %}
                {{ ticket.batch.name }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>
      <!-- Action form -->
      {% if ticket.manual_actions.exists %}
        <div class="card mb-3">
          <div class="card-header">
            <strong>Actions</strong>
            {% if ticket.status != "inprogress" %}<small>(Disabled due to ticket status)</small>{% endif %}
          </div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
              {% for action in ticket.manual_actions %}
                {% if action.is_completed %}
                  {# Completed action #}
                  <button class="btn btn-sm btn-outline-secondary"
                          disabled
                          title="Action already completed">{{ action.label }}</button>
                {% elif ticket.status != "inprogress" %}
                  <button class="btn btn-sm btn-outline-secondary"
                          disabled
                          title="Ticket must be in progress to run actions">{{ action.label }}</button>
                {% else %}
                  {# Active + allowed #}
                  <form method="post"
                        action="{% url 'tickets:run_action' action.id %}"
                        class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-{{ action.button_color }}">{{ action.label }}</button>
                  </form>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}
      <!-- Update form -->
      <div class="card">
        <div class="card-body">
          <h6>Update Ticket</h6>
          <form method="post" action="{% url 'tickets:update_ticket' ticket.id %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-sm btn-primary">Save changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
