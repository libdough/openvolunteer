{% extends "base.html" %}

{% block content %}
  {% if request.GET.next %}
    <a href="{{ request.GET.next }}"
       class="btn btn-sm btn-outline-secondary mb-3">← Back to tickets</a>
  {% else %}
    <a href="{% url 'tickets:ticket_list' %}"
       class="btn btn-sm btn-outline-secondary mb-3">← Back to tickets</a>
  {% endif %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ ticket.name }}</h1>
    <div>
      {% if can_claim and ticket.assigned_to != request.user %}
        <a href="{% url 'tickets:claim_ticket' ticket.id %}"
           class="btn btn-sm btn-primary">Claim ticket</a>
      {% endif %}
      {% if can_unclaim %}
        <a href="{% url 'tickets:unclaim_ticket' ticket.id %}"
           class="btn btn-sm btn-outline-secondary">Unclaim</a>
      {% endif %}
    </div>
  </div>
  <!-- Toolbar -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <form id="ticket-update-form"
            class="d-flex flex-wrap align-items-center gap-3"
            onsubmit="return false;">
        {% csrf_token %}
        <!-- STATUS BUTTONS -->
        <div class="btn-group btn-group-sm"
             role="group"
             aria-label="Ticket status">
          {% for value,label in status_buttons %}
            <button type="button"
                    class="btn {% if value == form.status.value %}btn-primary disabled{% elif form.status.value == 'open' %}btn-secondary disabled{% else %}btn-outline-primary{% endif %}"
                    {% if value == form.status.value %}disabled{% endif %}
                    onclick="setStatus('{{ value }}', this)">{{ label }}</button>
          {% endfor %}
        </div>
        <!-- HIDDEN STATUS FIELD (real form field) -->
        <input type="hidden"
               name="status"
               id="id_status"
               value="{{ form.status.value }}" />
        <!-- PRIORITY -->
        <div class="d-flex align-items-center gap-1">
          <span class="small text-muted">Priority</span>
          {{ form.priority }}
        </div>
        <!-- ASSIGNED -->
        <div class="d-flex align-items-center gap-1">
          <span class="small text-muted">Assigned</span>
          {{ form.assigned_to }}
        </div>
        {{ form.errors }}
      </form>
    </div>
  </div>
  <div class="row">
    <!-- Main content -->
    <div class="col-md-8">
      <div class="card mb-3">
        <div class="card-body">
          {% load markdown_extras %}

          <div class="markdown-body">{{ ticket.description|render_markdown|safe }}</div>
        </div>
      </div>
      <!-- Activity -->
      <div class="card mt-4 mb-3">
        <div class="card-header">
          <strong>Activity</strong>
        </div>
        <div class="card-body p-0 mb-1">
          {% if audit_logs %}
            <table class="table mb-0">
              <tbody>
                {% for log in audit_logs %}
                  <tr class="small">
                    <td>
                      <!-- Header -->
                      <div class="d-flex justify-content-between">
                        <span class="{% if not log.success %}text-danger{% endif %}">{{ log.message }}</span>
                        <span class="text-muted">{{ log.created_at|date:"M d, H:i" }}</span>
                      </div>
                      <!-- Actor -->
                      <div class="text-muted">
                        {% if log.actor %}
                          {{ log.actor }}
                        {% else %}
                          System
                        {% endif %}
                      </div>
                      <!-- Changed fields -->
                      {% if log.metadata.changed_fields %}
                        <div class="ps-2 border-start">
                          <ul class="list-unstyled mb-0">
                            {% for field, value in log.metadata.changed_fields.items %}
                              <li class="small">
                                <strong>{{ field|capfirst }}</strong> →
                                <span class="fw-medium">
                                  {% if field == "status" %}
                                    {{ ticket.get_status_display }}
                                  {% elif field == "priority" %}
                                    P{{ value }}
                                  {% elif field == "assigned_to" %}
                                    {% if value %}
                                      {{ value }}
                                    {% else %}
                                      Unassigned
                                    {% endif %}
                                  {% else %}
                                    {{ value }}
                                  {% endif %}
                                </span>
                              </li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                      <!-- Validation errors -->
                      {% if not log.success and log.metadata.errors %}
                        <div class="text-danger small">
                          <strong>Errors:</strong>
                          <ul class="mb-0">
                            {% for field, errors in log.metadata.errors.items %}<li>{{ field }}: {{ errors|join:", " }}</li>{% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            {% include "components/pagination.html" %}
          {% else %}
            <div class="p-3 text-muted text-center">No activity yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Sidebar -->
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-5">Status</dt>
            <dd class="col-7">
              {{ ticket.get_status_display }}
            </dd>
            <dt class="col-5">Priority</dt>
            <dd class="col-7">
              {% with priority=ticket.priority %}
                {% include "components/ticket_priority.html" %}
              {% endwith %}
            </dd>
            <dt class="col-5">Assigned</dt>
            <dd class="col-7">
              {% if ticket.assigned_to %}
                {{ ticket.assigned_to.name|default:ticket.assigned_to }}
              {% else %}
                <span class="text-muted">Unassigned</span>
              {% endif %}
            </dd>
            <dt class="col-5">Reporter</dt>
            <dd class="col-7">
              {{ ticket.reporter.name|default:ticket.reporter }}
            </dd>
            <dt class="col-5">Person</dt>
            <dd class="col-7">
              {% if ticket.person %}
                <a href="{% url 'people:person_detail' ticket.person.id %}">{{ ticket.person.discord|default:ticket.person }}</a>
              {% else %}
                <span class="text-muted">None</span>
              {% endif %}
            </dd>
            <dt class="col-5">Event</dt>
            <dd class="col-7">
              {% if ticket.event %}
                <a href="{% url 'events:event_detail' ticket.event.id %}">{{ ticket.event.title }}</a>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
            <dt class="col-5">Batch</dt>
            <dd class="col-7 ">
              {% if ticket.batch %}
                <small>
                  <a href="{% url 'tickets:ticket_list' %}?batch={{ ticket.batch.id }}">{{ ticket.batch.name|truncatechars:20 }}</a>
                </small>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </dd>
            {% if not can_claim and ticket.assigned_to != request.user %}
              <small>You lack permissions to claim this ticket</small>
            {% endif %}
          </dl>
        </div>
      </div>
      <!-- Action form -->
      {% with ticket=ticket actions=ticket.manual_actions can_run_action=can_run_action %}
        {% include "components/ticket_actions.html" %}
      {% endwith %}
    </div>
  </div>
  <script>
    const form = document.getElementById("ticket-update-form");
    const updateUrl = "{% url 'tickets:update_ticket' ticket.id %}";
    const csrfToken = "{{ csrf_token }}";

    function submitForm(triggerEl = null) {
      // ⬅️ Build FormData FIRST
      const formData = new FormData(form);

      if (triggerEl) triggerEl.disabled = true;

      fetch(updateUrl, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
          },
          body: formData,
        })
        .then(async (resp) => {
          const data = await resp.json();
          if (!resp.ok) throw data;
          return data;
        })
        .then(() => {
          window.location.reload();
        })
        .catch((err) => {
          if (triggerEl) triggerEl.disabled = false;

          if (err.err) {
            alert(
              Object.values(err.err)
              .flat()
              .join("\n")
            );
          } else {
            console.error(err);
            alert("Update failed.");
          }
        });
    }

    function setStatus(value, btn) {
      document.getElementById("id_status").value = value;

      document
        .querySelectorAll('[aria-label="Ticket status"] button')
        .forEach((b) => {
          b.classList.remove("btn-primary");
          b.classList.add("btn-outline-primary");
          b.disabled = false;
        });

      btn.classList.remove("btn-outline-primary");
      btn.classList.add("btn-primary");
      btn.disabled = true;

      submitForm(btn);
    }

    // Auto-submit dropdowns
    form.querySelectorAll("select").forEach((el) => {
      el.addEventListener("change", () => submitForm(el));
    });
  </script>
{% endblock content %}
